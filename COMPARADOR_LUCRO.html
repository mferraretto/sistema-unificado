async function calcularERegistrar() {
  const get = id => parseFloat(document.getElementById(id)?.value) || 0;
  const produto = document.getElementById('produto').value;
  const precoManual = get('precoVenda');
  const custo = get('custoProduto');

  atualizarPrecosMinimos(); // Atualiza os preços antes de calcular

  const calc = plataforma => {
    const taxa = get(plataforma + 'Taxa');
    const fixo = get(plataforma + 'Fixo');
    const frete = get(plataforma + 'Frete');
    const transacao = get(plataforma + 'Transacao');
    const transferencia = get(plataforma + 'Transferencia');
    const antecipacao = get(plataforma + 'Antecipacao');
    const variavel = get(plataforma + 'Variavel');
    const imposto = get(plataforma + 'Imposto');
    const comissao = get(plataforma + 'Comissao');

    const preco = precoManual || calcularPrecoMinimo(plataforma);
    const taxaTotal = preco * ((taxa + transacao + transferencia + antecipacao) / 100);
    const sobra = preco - taxaTotal - fixo - frete - variavel;
    const comissaoValor = sobra * (comissao / 100);
    const impostoValor = preco * (imposto / 100);
    const lucro = sobra - comissaoValor - impostoValor - custo;
    const margem = (lucro / preco) * 100;

    const nomes = {
      ml: 'Mercado Livre',
      sh: 'Shopee',
      mg: 'Magalu',
      shn: 'Shein'
    };

    return {
      plataforma: nomes[plataforma] || plataforma.toUpperCase(),
      produto,
      preco: preco.toFixed(2),
      taxaTotal: taxaTotal.toFixed(2),
      fixo: fixo.toFixed(2),
      frete: frete.toFixed(2),
      transacao: transacao.toFixed(2),
      transferencia: transferencia.toFixed(2),
      antecipacao: antecipacao.toFixed(2),
      variavel: variavel.toFixed(2),
      sobra: sobra.toFixed(2),
      comissao: comissaoValor.toFixed(2),
      imposto: impostoValor.toFixed(2),
      custo: custo.toFixed(2),
      lucro: lucro.toFixed(2),
      margem: margem.toFixed(2)
    };
  };

  const ml = calc('ml');
  const sh = calc('sh');
  const mg = calc('mg');
  const shn = calc('shn');

  // Salvar localmente
  const registros = JSON.parse(localStorage.getItem('resultadosLucro')) || [];
  registros.push([ml, sh, mg, shn]);
  localStorage.setItem('resultadosLucro', JSON.stringify(registros));

  // Salvar no Firebase
  try {
    await firebase.firestore().collection("resultadosLucro").add({
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      produto: produto,
      ml: ml,
      sh: sh,
      mg: mg,
      shn: shn
    });
    console.log("Cálculo salvo no Firebase com sucesso!");
  } catch (error) {
    console.error("Erro ao salvar no Firebase:", error);
  }

  // Atualizar tela
  desenharGraficoLucro(ml, sh);
  renderizarCards({ ml, sh, mg, shn });
  mostrarAba('resultados');
}
